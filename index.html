<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- DEVELOPER NOTE: Version 2.0 - Comprehensive Hub with Integrated Navigation -->
    <!-- This version of index.html serves as a fully functional hub, parallel to home.html, with a robust sidebar and content sections. -->
    <title>Dynamic Financial Learning Hub - Main</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/global_nav.css">
    
    <style>
        /* --- Base Styles & Modern Color Palette --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
            color: #1e293b; /* Slate 800 */
        }

        /* --- Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #4338ca;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* --- Main Navigation Tabs --- */
        .nav-button {
            position: relative;
            padding: 1rem 0.5rem;
            font-weight: 600;
            color: #475569; /* Slate 600 */
            transition: color 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .nav-button:hover { color: #1e293b; }
        .nav-button.active {
            color: #4338ca; /* Indigo 700 */
            border-bottom-color: #4338ca;
        }

        /* --- Enhanced Card Styles --- */
        .content-card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* 12px */
            border: 1px solid #e2e8f0; /* Slate 200 */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }
        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 10px -4px rgba(0, 0, 0, 0.07);
        }
        
        /* --- Interactive Module List --- */
        .module-card {
            cursor: pointer;
            border-left-width: 4px;
            border-color: #cbd5e1;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .module-card:hover {
            background-color: #f1f5f9;
            border-left-color: #64748b;
        }
        .module-card.active {
            background-color: #eef2ff;
            border-left-color: #4f46e5;
            font-weight: 600;
        }

        /* --- Helper for SPA view management --- */
        .content-section:not(.active) { display: none; }

        /* --- Sidebar Styles --- */
        .sidebar { transition: transform 0.3s ease-in-out; }
        @media (max-width: 1023px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
        }

        /* --- Progress Bar --- */
        .progress-bar-inner {
            background-color: #4ade80; /* Green 400 */
            transition: width 0.5s ease-in-out;
        }
        
        .progress-bar-inner.completed {
            background-color: #4338ca; /* Indigo-600 */
        }

        /* --- Filter Buttons --- */
        .filter-btn.active {
            background-color: #4338ca !important;
            color: #ffffff !important;
        }

        /* --- Custom Modal for Alerts --- */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-backdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-backdrop.visible .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Custom Alert Modal -->
    <div id="custom-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-slate-800 mb-4">Notification</h3>
            <p id="modal-message" class="text-slate-600 mb-6">This is a message.</p>
            <button id="modal-close-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Close</button>
        </div>
    </div>

    <div class="relative min-h-screen lg:flex">
        <!-- Global Navigation Sidebar -->
        <div id="global-nav-placeholder" class="sidebar fixed top-0 left-0 h-full w-64 bg-white border-r border-slate-200 z-40 lg:relative lg:translate-x-0">
            <!-- Global navigation will be injected here by js/global_nav.js -->
        </div>
        
        <div id="sidebar-backdrop" class="fixed inset-0 bg-black/30 z-30 hidden lg:hidden"></div>

        <div class="flex-1 flex flex-col">
            <!-- === MOBILE HEADER & SIDEBAR TOGGLE === -->
            <header class="lg:hidden sticky top-0 bg-white/80 backdrop-blur-md z-30 flex items-center justify-between p-4 border-b border-slate-200">
                <h2 class="font-bold text-lg text-slate-800">Financial Hub</h2>
                <button id="menu-toggle" class="p-2 rounded-md hover:bg-slate-100" aria-label="Open menu"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
            </header>

            <div class="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto">
                <nav class="flex justify-center border-b border-slate-300 mb-8" role="tablist" aria-label="Learning Paths">
                    <div class="flex flex-wrap justify-center space-x-2 md:space-x-6">
                        <button role="tab" id="tab-dashboard" data-view="dashboard" class="nav-button active">Dashboard</button>
                        <button role="tab" id="tab-creditAnalyst" data-view="creditAnalyst" class="nav-button">Credit Analyst Path</button>
                        <button role="tab" id="tab-cfaCandidate" data-view="cfaCandidate" class="nav-button">CFAÂ® Candidate Path</button>
                        <a href="copilot_hub.html" class="nav-button">AI Copilot Hub</a>
                    </div>
                </nav>

                <main id="mainContent">
                    <!-- 1. DASHBOARD VIEW -->
                    <section id="view-dashboard" class="content-section active space-y-8" role="tabpanel" aria-labelledby="tab-dashboard">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2 content-card p-8 flex flex-col justify-center bg-indigo-700 text-white">
                                <h2 class="text-3xl font-bold mb-2">Welcome Back!</h2>
                                <p class="text-indigo-200 text-lg">Let's continue your journey to mastering finance.</p>
                                <a href="#" id="continue-last-module-btn" class="mt-6 bg-white text-indigo-700 font-bold py-2 px-5 rounded-lg self-start hover:bg-indigo-50 transition-all">Continue Last Module</a>
                            </div>
                            <div class="content-card p-6">
                                <h3 class="font-semibold text-lg mb-4 text-slate-800">Your Progress</h3>
                                <div id="dashboard-progress" class="space-y-4"></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="content-card p-6">
                                <h3 class="font-semibold text-lg mb-4 text-slate-800">Explore Learning Resources</h3>
                                <div id="resource-filters" class="flex flex-wrap gap-2 mb-6"></div>
                                <div id="resource-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                            </div>

                            <div class="content-card p-6">
                                <h3 class="font-semibold text-lg mb-4 text-slate-800">AI Concept Explainer</h3>
                                <p class="text-sm text-slate-500 mb-4">Enter a financial term (e.g., "Quantitative Easing", "Derivatives") to get a simple explanation.</p>
                                <div class="flex gap-2">
                                    <input type="text" id="ai-prompt-input" placeholder="Enter a financial term..." class="w-full text-slate-700 bg-slate-100 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 py-2 px-3">
                                    <button id="ai-explain-btn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center">
                                        <span id="ai-btn-text">Explain</span>
                                        <div id="ai-btn-loader" class="loader hidden"></div>
                                    </button>
                                </div>
                                <div id="ai-response-container" class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200 min-h-[100px] text-slate-700 text-sm">
                                    AI responses will appear here...
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- 2. CREDIT ANALYST PATH VIEW -->
                    <section id="view-creditAnalyst" class="content-section" role="tabpanel" aria-labelledby="tab-creditAnalyst">
                        <div class="text-center max-w-3xl mx-auto mb-12">
                            <h2 class="text-3xl font-bold text-slate-800 mb-4">Credit Analyst Learning Path (CRAFT)</h2>
                            <p class="text-slate-600 text-lg">A comprehensive, 11-module program taking you from foundational principles to advanced, specialized topics.</p>
                        </div>
                        <div class="lg:flex gap-8">
                            <aside class="lg:w-2/5 mb-8 lg:mb-0">
                                <h3 class="font-semibold text-xl mb-4 text-slate-800">CRAFT Program Modules</h3>
                                <div id="creditRiskModules" class="space-y-2"></div>
                            </aside>
                            <div class="lg:w-3/5"><div id="creditRiskModuleDetail" class="content-card p-6 lg:sticky top-8"></div></div>
                        </div>
                    </section>

                    <!-- 3. CFA CANDIDATE PATH VIEW -->
                    <section id="view-cfaCandidate" class="content-section" role="tabpanel" aria-labelledby="tab-cfaCandidate">
                        <div class="text-center max-w-3xl mx-auto mb-12"><h2 class="text-3xl font-bold text-slate-800 mb-4">CFAÂ® Candidate Path</h2><p class="text-slate-600 text-lg">Navigate your CFA journey with a toolkit designed for success. Explore focused resources below.</p></div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="content-card p-6 lg:col-span-2">
                                <h3 class="font-semibold text-xl mb-6 text-slate-800">Resource Toolkit</h3>
                                 <div id="cfa-resource-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                            </div>
                            <div class="content-card p-6"><h3 class="font-semibold text-xl mb-4 text-center text-slate-800">Ethics Exam Weighting</h3><p class="text-slate-600 text-center text-sm mb-4">Ethics holds significant weight (10-15%) on all exams.</p><div class="relative h-64"><canvas id="ethicsChart"></canvas></div></div>
                        </div>
                    </section>
                </main>
            </div>
        </div>
    </div>

    <script src="js/nav_data.js" defer></script>
    <script src="js/global_nav.js" defer></script>
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // --- FIREBASE SETUP ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            // setLogLevel('debug');

            let userId = null;
            let dbUnsubscribe = () => {};

            // --- AUTHENTICATION ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                    initialize(userId);
                }
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                showModal("Authentication Error", "Could not sign in. Some features might not work correctly.");
            }

            // --- 1. STATIC DATA STORE ---
            const appData = {
                resources: [
                    { id: 'r1', title: 'Corporate Credit Risk (CRAFT)', description: 'Full 11-module curriculum.', category: 'Core Program', path: 'creditAnalyst' },
                    { id: 'r2', title: 'CFAÂ® Program Prep', description: 'Study hub for all three levels.', category: 'Core Program', path: 'cfaCandidate' },
                    { id: 'r3', title: 'Financial Modeling', description: 'Best practices, templates, and valuation.', category: 'Skill Building', path: 'dashboard' },
                    { id: 'r4', title: 'Industry Primers', description: 'Insights into 15+ key sectors.', category: 'Special Topics', path: 'dashboard' },
                    { id: 'r5', title: 'Market Analysis Quick Start', description: 'Learn market jargon and rules of thumb.', category: 'Skill Building', path: 'dashboard' },
                    { id: 'r6', title: 'Behavioral Finance', description: 'Understand cognitive biases in markets.', category: 'Special Topics', path: 'dashboard' },
                    { id: 'r7', title: 'Fintech Innovations', description: 'Explore AI, Blockchain, and Open Banking.', category: 'Special Topics', path: 'dashboard' },
                    { id: 'r8', title: 'Risk Management Frameworks', description: 'Governance, reporting, and risk types.', category: 'Skill Building', path: 'dashboard' },
                ],
                creditRisk: {
                    modules: [
                        { id: 'm1', title: '01: Foundations', content: 'Covers accounting and financial modeling basics.' },
                        { id: 'm2', title: '02: Understanding the Market', content: 'Explores capital markets and industry analysis.' },
                        { id: 'm3', title: '03: The Analyst\'s Craft', content: 'Develops crucial soft skills for credit narratives.' },
                        { id: 'm4', title: '04: The Credit Lifecycle', content: 'Covers underwriting, LBO & M&A analysis.' },
                        { id: 'm5', title: '05: Future of Risk Management', content: 'Forward-looking module on AI in risk management.' },
                        { id: 'm6', title: '06: Advanced Topics', content: 'Deep dives into QoE and debt structuring.' },
                    ]
                },
                cfaResources: [
                    { id: 'cfa1', title: 'Topic Deep Dives', content: 'In-depth explorations of complex curriculum areas.' },
                    { id: 'cfa2', title: 'Concise Cheat Sheets', content: 'Quick summaries of formulas and concepts.' },
                    { id: 'cfa3', title: 'Practice Exams', content: 'Simulate exam conditions for all levels.' },
                    { id: 'cfa4', title: 'Practical Case Studies', content: 'Apply theory to realistic scenarios.' },
                ]
            };

            // --- 2. DOM ELEMENT SELECTORS ---
            const elements = {
                navButtons: document.querySelectorAll('.nav-button'),
                contentSections: document.querySelectorAll('.content-section'),
                creditRiskModulesContainer: document.getElementById('creditRiskModules'),
                creditRiskModuleDetailContainer: document.getElementById('creditRiskModuleDetail'),
                cfaResourceGrid: document.getElementById('cfa-resource-grid'),
                ethicsChartCanvas: document.getElementById('ethicsChart'),
                sidebar: document.getElementById('global-nav-placeholder'),
                menuToggle: document.getElementById('menu-toggle'),
                sidebarBackdrop: document.getElementById('sidebar-backdrop'),
                dashboardProgress: document.getElementById('dashboard-progress'),
                resourceGrid: document.getElementById('resource-grid'),
                resourceFilters: document.getElementById('resource-filters'),
                aiPromptInput: document.getElementById('ai-prompt-input'),
                aiExplainBtn: document.getElementById('ai-explain-btn'),
                aiBtnText: document.getElementById('ai-btn-text'),
                aiBtnLoader: document.getElementById('ai-btn-loader'),
                aiResponseContainer: document.getElementById('ai-response-container'),
                continueLastModuleBtn: document.getElementById('continue-last-module-btn'),
                modal: document.getElementById('custom-modal'),
                modalTitle: document.getElementById('modal-title'),
                modalMessage: document.getElementById('modal-message'),
                modalCloseBtn: document.getElementById('modal-close-btn'),
            };

            // --- 3. STATE MANAGEMENT ---
            let userState = {
                progress: {},
                lastInteraction: null
            };

            // --- 4. RENDERING & LOGIC FUNCTIONS ---
            
            // Utility to show a custom modal
            const showModal = (title, message) => {
                elements.modalTitle.textContent = title;
                elements.modalMessage.textContent = message;
                elements.modal.classList.add('visible');
            }

            // Switch between the main views (Dashboard, Credit Analyst, etc.)
            const switchView = (viewId, resourceId = null) => {
                elements.contentSections.forEach(s => s.classList.remove('active'));
                const targetView = document.getElementById(`view-${viewId}`);
                if (targetView) {
                    targetView.classList.add('active');
                    targetView.classList.remove('fade-in');
                    void targetView.offsetWidth;
                    targetView.classList.add('fade-in');
                }
                elements.navButtons.forEach(b => {
                    const isActive = b.dataset.view === viewId;
                    b.classList.toggle('active', isActive);
                    b.setAttribute('aria-selected', isActive);
                });

                if (viewId === 'creditAnalyst') {
                    updateCreditRiskModuleDetail(resourceId || appData.creditRisk.modules[0].id);
                }
            };
            
            // Update the user's progress in Firestore
            const updateUserProgress = async (resourceId) => {
                if (!userId) return;
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
                const isCompleted = userState.progress[resourceId];
                
                const newProgress = { ...userState.progress, [resourceId]: !isCompleted };
                const newInteraction = { id: resourceId, timestamp: new Date().toISOString() };

                try {
                    await updateDoc(userDocRef, { 
                        progress: newProgress,
                        lastInteraction: newInteraction
                    });
                } catch(e) {
                     // If doc doesn't exist, create it
                    if (e.code === 'not-found') {
                        await setDoc(userDocRef, { 
                            progress: newProgress,
                            lastInteraction: newInteraction
                        });
                    } else {
                        console.error("Error updating progress:", e);
                        showModal("Database Error", "Could not save your progress.");
                    }
                }
            };
            
            // Render the progress bars on the dashboard
            const renderDashboardProgress = () => {
                if (!elements.dashboardProgress) return;
                const pathProgress = [
                    { label: 'Credit Risk Path', ids: appData.creditRisk.modules.map(m => m.id) },
                    { label: 'CFA Prep', ids: appData.cfaResources.map(r => r.id) }
                ];

                elements.dashboardProgress.innerHTML = pathProgress.map(path => {
                    const completedCount = path.ids.filter(id => userState.progress[id]).length;
                    const totalCount = path.ids.length;
                    const percent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                    return `
                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <span class="text-sm font-medium text-slate-600">${path.label}</span>
                                <span class="text-sm font-bold text-slate-500">${percent}%</span>
                            </div>
                            <div class="progress-bar h-2 w-full rounded-full bg-slate-200"><div class="progress-bar-inner h-full rounded-full ${percent === 100 ? 'completed' : ''}" style="width: ${percent}%"></div></div>
                        </div>
                    `;
                }).join('');
            };

            // Render the filter buttons for resources on the dashboard
            const renderResourceFilters = () => {
                if (!elements.resourceFilters) return;
                const categories = ['All', ...new Set(appData.resources.map(r => r.category))];
                elements.resourceFilters.innerHTML = categories.map(cat => `
                    <button class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-full transition ${cat === 'All' ? 'active' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}" data-filter="${cat}">
                        ${cat}
                    </button>
                `).join('');
            };
            
            // Render the grid of learning resources on the dashboard
            const renderResourceGrid = (filter = 'All') => {
                if (!elements.resourceGrid) return;
                const filteredResources = filter === 'All' 
                    ? appData.resources 
                    : appData.resources.filter(r => r.category === filter);

                elements.resourceGrid.innerHTML = filteredResources.map(res => {
                    const isCompleted = userState.progress[res.id];
                    return `
                    <div class="content-card p-6 flex flex-col">
                        <h4 class="font-bold text-lg text-slate-900 mb-2">${res.title}</h4>
                        <p class="text-slate-600 text-sm mb-4 flex-1">${res.description}</p>
                        <button data-resource-id="${res.id}" class="toggle-completion-btn w-full text-center mt-2 font-semibold py-2 px-4 rounded-lg text-sm transition ${isCompleted ? 'bg-indigo-100 text-indigo-700' : 'bg-indigo-600 text-white hover:bg-indigo-700'}">
                            ${isCompleted ? 'â Completed' : 'Mark as Complete'}
                        </button>
                    </div>`;
                }).join('');
                
                // Re-add event listeners for the new buttons
                document.querySelectorAll('.toggle-completion-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const resourceId = e.target.dataset.resourceId;
                        updateUserProgress(resourceId);
                    });
                });
            };

            // Render the list of modules for the Credit Analyst path
            const renderCreditRiskModules = () => {
                if (!elements.creditRiskModulesContainer) return;
                elements.creditRiskModulesContainer.innerHTML = appData.creditRisk.modules.map(m => `
                    <div class="content-card module-card p-4" data-id="${m.id}" role="button" tabindex="0">
                        <h4 class="font-semibold text-slate-800 pointer-events-none">${m.title}</h4>
                    </div>`).join('');
            };

            // Show the details for a selected Credit Analyst module
            const updateCreditRiskModuleDetail = (moduleId) => {
                if (!elements.creditRiskModuleDetailContainer) return;
                const moduleData = appData.creditRisk.modules.find(m => m.id === moduleId);
                if (moduleData) {
                    const isCompleted = userState.progress[moduleData.id];
                    elements.creditRiskModuleDetailContainer.innerHTML = `
                        <h3 class="font-bold text-2xl mb-3 text-slate-900">${moduleData.title}</h3>
                        <p class="text-slate-600 text-base mb-6">${moduleData.content}</p>
                         <button data-resource-id="${moduleData.id}" class="toggle-completion-btn w-full md:w-auto text-center mt-2 font-semibold py-2 px-4 rounded-lg text-sm transition ${isCompleted ? 'bg-indigo-100 text-indigo-700' : 'bg-indigo-600 text-white hover:bg-indigo-700'}">
                            ${isCompleted ? 'â Completed' : 'Mark as Complete'}
                        </button>
                    `;
                    document.querySelectorAll('#creditRiskModules .module-card').forEach(c => c.classList.toggle('active', c.dataset.id === moduleId));
                    // Add listener to the newly created button
                    elements.creditRiskModuleDetailContainer.querySelector('.toggle-completion-btn').addEventListener('click', (e) => updateUserProgress(e.target.dataset.resourceId));
                }
            };
            
            // Render the resources for the CFA Candidate path
            const renderCfaResourceGrid = () => {
                if (!elements.cfaResourceGrid) return;
                elements.cfaResourceGrid.innerHTML = appData.cfaResources.map(res => {
                    const isCompleted = userState.progress[res.id];
                    return `
                    <div class="content-card p-6 flex flex-col">
                        <h4 class="font-semibold text-lg text-indigo-800 mb-2">${res.title}</h4>
                        <p class="text-slate-700 flex-1">${res.content}</p>
                        <button data-resource-id="${res.id}" class="toggle-completion-btn w-full text-center mt-4 font-semibold py-2 px-4 rounded-lg text-sm transition ${isCompleted ? 'bg-indigo-100 text-indigo-700' : 'bg-indigo-600 text-white hover:bg-indigo-700'}">
                            ${isCompleted ? 'â Completed' : 'Mark as Complete'}
                        </button>
                    </div>`;
                }).join('');

                 document.querySelectorAll('#cfa-resource-grid .toggle-completion-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => updateUserProgress(e.target.dataset.resourceId));
                });
            };

            // Initialize the doughnut chart for CFA ethics
            const initEthicsChart = () => {
                if (!elements.ethicsChartCanvas || elements.ethicsChartCanvas.chart) return;
                elements.ethicsChartCanvas.chart = new Chart(elements.ethicsChartCanvas.getContext('2d'), {
                    type: 'doughnut', data: { labels: ['Ethics', 'Other Topics'], datasets: [{ data: [12.5, 87.5], backgroundColor: ['#4f46e5', '#e2e8f0'], borderColor: '#fff', borderWidth: 4, hoverOffset: 8 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.label}: ${c.parsed.toFixed(1)}%` } } } }
                });
            };

            // Toggle the mobile sidebar
            const toggleSidebar = () => {
                elements.sidebar.classList.toggle('open');
                elements.sidebarBackdrop.classList.toggle('hidden');
            };

            // Update the "Continue Last Module" button
            const updateContinueButton = () => {
                if(!userState.lastInteraction || !userState.lastInteraction.id) {
                    elements.continueLastModuleBtn.style.display = 'none';
                    return;
                }
                
                elements.continueLastModuleBtn.style.display = 'inline-block';
                const lastResourceId = userState.lastInteraction.id;

                let resource = appData.resources.find(r => r.id === lastResourceId);
                if (!resource) resource = appData.creditRisk.modules.find(m => m.id === lastResourceId);
                if (!resource) resource = appData.cfaResources.find(r => r.id === lastResourceId);
                
                let targetPath = 'dashboard';
                if(appData.creditRisk.modules.some(m => m.id === lastResourceId)) targetPath = 'creditAnalyst';
                if(appData.cfaResources.some(c => c.id === lastResourceId)) targetPath = 'cfaCandidate';

                elements.continueLastModuleBtn.onclick = (e) => {
                    e.preventDefault();
                    switchView(targetPath, lastResourceId);
                };
            };

            // --- 5. AI INTEGRATION ---
            const handleAIExplain = async () => {
                const promptText = elements.aiPromptInput.value.trim();
                if (!promptText) {
                    showModal("Input Required", "Please enter a financial term to explain.");
                    return;
                }

                elements.aiBtnText.classList.add('hidden');
                elements.aiBtnLoader.classList.remove('hidden');
                elements.aiExplainBtn.disabled = true;
                elements.aiResponseContainer.innerHTML = 'Generating explanation...';

                const prompt = `Explain the financial concept of "${promptText}" in simple terms, as if you were explaining it to a beginner. Keep it concise and clear.`;
                const payload = {
                  contents: [{ role: "user", parts: [{ text: prompt }] }],
                };
                const apiKey = ""; // Leave empty, will be handled by environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    
                    const result = await response.json();

                    if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                        const text = result.candidates[0].content.parts[0].text;
                        elements.aiResponseContainer.innerHTML = text.replace(/\n/g, '<br>'); // Basic formatting
                    } else {
                        throw new Error("Invalid response format from AI.");
                    }
                } catch (error) {
                    console.error("AI Generation Error:", error);
                    elements.aiResponseContainer.innerHTML = 'Sorry, an error occurred while generating the explanation. Please try again.';
                    showModal("AI Error", `An error occurred: ${error.message}`);
                } finally {
                    elements.aiBtnText.classList.remove('hidden');
                    elements.aiBtnLoader.classList.add('hidden');
                    elements.aiExplainBtn.disabled = false;
                }
            };
            

            // --- 6. EVENT LISTENERS & INITIALIZATION ---
            const setupEventListeners = () => {
                elements.navButtons.forEach(b => b.addEventListener('click', () => switchView(b.dataset.view)));
                
                if (elements.creditRiskModulesContainer) {
                    elements.creditRiskModulesContainer.addEventListener('click', e => { 
                        const card = e.target.closest('.module-card');
                        if (card) {
                            updateCreditRiskModuleDetail(card.dataset.id);
                            updateUserProgress(card.dataset.id); // Mark as interacted
                        }
                    });
                }
                
                if (elements.resourceFilters) {
                    elements.resourceFilters.addEventListener('click', e => {
                        if (e.target.tagName === 'BUTTON') {
                            document.querySelectorAll('#resource-filters button').forEach(btn => btn.classList.remove('active', 'bg-indigo-600', 'text-white'));
                            e.target.classList.add('active', 'bg-indigo-600', 'text-white');
                            renderResourceGrid(e.target.dataset.filter);
                        }
                    });
                }
                
                if (elements.menuToggle) elements.menuToggle.addEventListener('click', toggleSidebar);
                if (elements.sidebarBackdrop) elements.sidebarBackdrop.addEventListener('click', toggleSidebar);

                elements.aiExplainBtn.addEventListener('click', handleAIExplain);
                elements.aiPromptInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handleAIExplain();
                });

                elements.modalCloseBtn.addEventListener('click', () => elements.modal.classList.remove('visible'));
            };

            const initialize = (currentUserId) => {
                if (!currentUserId) {
                    console.error("Initialization aborted: No user ID.");
                    showModal("Initialization Error", "Could not verify user. Data will not be saved.");
                    return;
                }
                
                // Set up Firestore listener
                const userDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                dbUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        userState = { ...userState, ...docSnap.data() };
                    } else {
                        console.log("No user data found, creating new document.");
                        // Create a default state if the document doesn't exist
                        setDoc(userDocRef, { progress: {}, lastInteraction: null });
                    }
                    
                    // Re-render everything that depends on user state
                    renderDashboardProgress();
                    renderResourceGrid(); // Will render with 'All' filter by default
                    updateContinueButton();
                    // Update any other components that need it
                    renderCfaResourceGrid();
                    if(document.getElementById('view-creditAnalyst').classList.contains('active')){
                        const activeModule = document.querySelector('#creditRiskModules .module-card.active');
                        if(activeModule) updateCreditRiskModuleDetail(activeModule.dataset.id);
                    }
                }, (error) => {
                    console.error("Firestore snapshot error:", error);
                    showModal("Database Error", "Could not sync your data in real-time.");
                });
                
                // Initial Renders (static content)
                renderResourceFilters();
                renderCreditRiskModules();
                renderCfaResourceGrid();
                
                // Set default views
                if (appData.creditRisk.modules.length > 0) {
                    updateCreditRiskModuleDetail(appData.creditRisk.modules[0].id);
                }
                
                initEthicsChart();
                setupEventListeners();
                switchView('dashboard'); 
            };
        });
    </script>
</body>
</html>
